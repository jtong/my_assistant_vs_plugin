<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSGradio Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #vsgradio-container {
            max-width: 600px;
            margin: 0 auto;
        }

        input, button {
            margin: 10px 0;
            padding: 5px;
        }

        button {
            cursor: pointer;
        }

        #outputs {
            margin-top: 20px;
        }

        .row {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div id="vsgradio-container"></div>

    <script>
        const vscode = acquireVsCodeApi();
        let interfaceConfig = null;

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'setInterface':
                    interfaceConfig = message.value;
                    renderInterface(interfaceConfig);
                    break;
                case 'updateOutput':
                    updateOutput(message.value);
                    break;
                case 'eventResult':
                    handleEventResult(message);
                    break;
            }
        });

        function renderInterface(config) {
            const container = document.getElementById('vsgradio-container');
            container.innerHTML = `
                <h2>${config.title || ''}</h2>
                <div id="inputs">
                    ${renderBlocks(config.blocks)}
                </div>
                ${config.outputs ? `<div id="outputs">${config.outputs.map(renderOutput).join('')}</div>` : ''}
            `;
            setupEventListeners(config);
        }

        function renderBlocks(blocks) {
            return blocks.map((block, index) => renderBlock(block, index)).join('');
        }

        function renderBlock(block, index) {
            if (block.type === 'row') {
                return `<div class="row" id="block_${index}">${block.children.map((child, childIndex) => renderBlock(child, `${index}_${childIndex}`)).join('')}</div>`;
            } else if (block.type === 'column') {
                return `<div class="column" id="block_${index}">${block.children.map((child, childIndex) => renderBlock(child, `${index}_${childIndex}`)).join('')}</div>`;
            } else if (block.type === 'text') {
                return `<input type="text" id="block_${index}" placeholder="${block.label}" value="${block.default || ''}" data-block-index="${index}">`;
            } else if (block.type === 'button') {
                return `<button id="block_${index}" data-block-index="${index}">${block.label}</button>`;
            }
            // 可以在这里添加更多块类型
        }

        function renderOutput(output) {
            return `<div id="${output.label}">${output.label}: <span></span></div>`;
        }

        function setupEventListeners(config) {
            setupBlockEventListeners(config.blocks);
        }

        function setupBlockEventListeners(blocks, parentPath = '') {
            blocks.forEach((block, index) => {
                const currentPath = parentPath ? `${parentPath}_${index}` : `block_${index}`;
                const element = document.getElementById(currentPath);
                if (element && block.events) {
                    block.events.forEach(eventName => {
                        element.addEventListener(eventName, (event) => {
                            const allInputs = getAllInputValues();
                            vscode.postMessage({
                                type: 'event',
                                blockPath: currentPath,
                                eventName: eventName,
                                args: [event.target.value],
                                allInputs: allInputs
                            });
                        });
                    });
                }
                if (block.children) {
                    setupBlockEventListeners(block.children, currentPath);
                }
            });
        }

        function getAllInputValues() {
            const inputs = {};
            document.querySelectorAll('input, button').forEach(element => {
                const id = element.id;
                const value = element.value || element.textContent;
                inputs[id] = value;
            });
            return inputs;
        }

        function updateOutput(value) {
            const outputElement = document.querySelector('#outputs span');
            if (outputElement) {
                outputElement.textContent = value;
            }
        }

        function handleEventResult(message) {
            console.log(`Event result for block ${message.blockPath}, event ${message.eventName}:`, message.result);
            // 可以在这里添加更多的处理逻辑
        }

        // 初始化时请求接口配置
        vscode.postMessage({ type: 'getInterface' });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSGradio Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #vsgradio-container {
            max-width: 600px;
            margin: 0 auto;
        }

        input,
        button {
            margin: 10px 0;
            padding: 5px;
        }

        button {
            cursor: pointer;
        }

        .row {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input[readonly] {
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>
    <div id="vsgradio-container"></div>

    <script>
        const vscode = acquireVsCodeApi();
        let interfaceConfig = null;

        function renderInterface(config) {
            const container = document.getElementById('vsgradio-container');
            container.innerHTML = `
                <h2>${config.title || ''}</h2>
                <div id="inputs">
                    ${renderBlocks(config.blocks)}
                </div>
            `;
            setupEventListeners(config);
        }

        function renderBlocks(blocks) {
            return blocks.map((block, index) => renderBlock(block, index)).join('');
        }

        function renderBlock(block, index) {
            if (block.type === 'row') {
                return `<div class="row" id="${block.id}" data-role="${block.role}">${block.children.map((child, childIndex) => renderBlock(child, `${index}_${childIndex}`)).join('')}</div>`;
            } else if (block.type === 'column') {
                return `<div class="column" id="${block.id}" data-role="${block.role}">${block.children.map((child, childIndex) => renderBlock(child, `${index}_${childIndex}`)).join('')}</div>`;
            } else if (block.type === 'text') {
                return `<input type="text" id="${block.id}" data-role="${block.role}" placeholder="${block.label}" value="${block.default || ''}" ${block.role === 'output' ? 'readonly' : ''}>`;
            } else if (block.type === 'button') {
                return `<button id="${block.id}" data-role="${block.role}">${block.label}</button>`;
            }
        }

        function setupEventListeners(config) {
            setupBlockEventListeners(config.blocks);
        }

        function setupBlockEventListeners(blocks, parentPath = '') {
            blocks.forEach((block, index) => {
                const currentPath = parentPath ? `${parentPath}_${index}` : `${block.id}`;
                const element = document.getElementById(block.id);
                if (element && block.events) {
                    block.events.forEach((eventName) => {
                        element.addEventListener(eventName, (event) => {
                            const allInputs = getAllInputValues();
                            console.log(`Event triggered: ${eventName} on ${block.id}`);
                            vscode.postMessage({
                                type: 'event',
                                componentId: block.id,
                                eventName: eventName,
                                args: [event.target.value],
                                allInputs: allInputs
                            });
                        });
                    });
                }
                if (block.children) {
                    setupBlockEventListeners(block.children, currentPath);
                }
            });
        }

        function getAllInputValues() {
            const inputs = {};
            document.querySelectorAll('input, button').forEach(element => {
                const id = element.id;
                const value = element.value || element.textContent;
                inputs[id] = value;
            });
            return inputs;
        }

        function updateOutput(value) {
            const outputElement = document.querySelector('#result');
            if (outputElement) {
                outputElement.value = value;
            }
        }

        function handleEventResult(message) {
            console.log(`Event result for component ${message.componentId}, event ${message.eventName}:`, message.result);

            if (message.result && message.result.type === 'updateOutput') {
                updateOutput(message.result.value);
            }

            // 可以在这里添加更多的处理逻辑
        }

        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message from extension:', message);  // 添加这行
            switch (message.type) {
                case 'setInterface':
                    interfaceConfig = message.value;
                    renderInterface(interfaceConfig);
                    break;
                case 'updateOutput':
                    updateOutput(message.value);
                    break;
                case 'eventResult':
                    handleEventResult(message);
                    break;
            }
        });

        // 初始化时请求接口配置
        vscode.postMessage({ type: 'getInterface' });
    </script>
</body>

</html> 